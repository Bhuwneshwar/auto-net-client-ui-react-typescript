const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/Chat-DzF0Y4ay.js","assets/index-BZ3Ke3M-.js","assets/index-BbSRFgUB.css","assets/Send-Bi0AwUdW.js","assets/formatDate-C7W8eSx1.js"])))=>i.map(i=>d[i]);
import{r as a,_,u as b,c as I,a as D,g as S,b as C,B as v,j as s,t as M}from"./index-BZ3Ke3M-.js";import{d as k}from"./ArrowForwardIos-CLp4eqQP.js";import{f as w}from"./formatDate-C7W8eSx1.js";const R=a.lazy(()=>_(()=>import("./Chat-DzF0Y4ay.js"),__vite__mapDeps([0,1,2,3,4]))),U=()=>{const{dispatch:c,store:{MyDetails:l,socketData:u}}=b(),m=I(),{refer:t}=D(),g=a.useRef(t),y=a.useRef([]),[r,d]=a.useState([]),[f,E]=a.useState({identifyId:""}),N=e=>{const{name:n,value:j}=e.target;E({...f,[n]:j})},o=S();a.useEffect(()=>{l&&c("MyDetails",{...l,allUnreadMessageCount:0}),h(),o==null||o.on("NEW_MESSAGE",()=>{})},[o]),a.useEffect(()=>{try{const e=JSON.parse(u);console.log("got message",{msg:e}),e.username!==t&&d(n=>n.filter(p=>p.referCode===e.username).length>0?n.map(i=>i.referCode===e.username?{...i,unreadMsgCount:i.unreadMsgCount+1}:i):(h(),n))}catch(e){console.log(e)}},[u,t]),a.useEffect(()=>{if(t){const e=r.map(n=>t===n.referCode?{...n,unreadMsgCount:0}:n);d(e)}g.current=t},[t]),a.useEffect(()=>{y.current=r},[r]);const h=async()=>{try{c("loading",!0);const{data:e}=await C.get("/api/v1/messages",{withCredentials:!0});console.log({data:e}),e.success&&d(e.usersList),e.error&&v.error(e.error,{position:"bottom-center"})}catch(e){console.log("initial error :",e),v.error("Failed to fetch messages",{position:"bottom-center"})}c("loading",!1)},x=async()=>{try{const{data:e}=await C.post("/api/v1/message/join",{user:f.identifyId},{withCredentials:!0});console.log({data:e}),e.referCode&&m("/messages/"+e.referCode)}catch(e){console.log("checkFunds error :",e)}};return s.jsxs("div",{id:"messages",children:[s.jsxs("div",{className:t?"container hideMe":"container",children:[s.jsx("h2",{children:"Messages"}),s.jsxs("div",{className:"join-box",children:[s.jsx("input",{onChange:N,value:f.identifyId,type:"text",name:"identifyId",onKeyUp:e=>{e.key==="Enter"&&x()},placeholder:"Username/ID/Phone Number/Email"}),s.jsx("button",{onClick:x,children:s.jsx(k,{})})]}),s.jsxs("div",{className:"chats",children:[s.jsx("div",{className:"for-over-follow",children:r.map(e=>s.jsxs("div",{className:"lastMessage",onClick:()=>m("/messages/"+e.referCode),children:[s.jsx("figure",{children:s.jsx("img",{src:e.profileImg,alt:e.name})}),s.jsxs("div",{className:"info",children:[s.jsx("h3",{children:M(e.name,20)}),s.jsxs("span",{children:[M(e.lastMsg,25)," "]})]}),s.jsxs("div",{className:"time",children:[s.jsx("div",{children:w(e.lastMsgTime)}),e.unreadMsgCount>0&&(e.unreadMsgCount<100?s.jsx("span",{className:"badge",children:e.unreadMsgCount}):s.jsx("span",{className:"badge",children:"99+"}))]})]},e.referCode))})," "]})]}),t&&l?s.jsx(a.Suspense,{fallback:s.jsx("div",{children:"Chat Loading..."}),children:s.jsx(R,{username:g.current||""})}):""]})};export{U as default};
